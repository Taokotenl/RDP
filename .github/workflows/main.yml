name: Remote Access via Tailscale (VNC) - Improved

on:
  workflow_dispatch:

jobs:
  remote_access:
    runs-on: macos-latest
    timeout-minutes: 360  # 6 hours

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Tailscale
        run: |
          echo "Installing Tailscale..."
          brew install tailscale
          
      - name: Configure macOS for VNC Access
        run: |
          echo "Configuring macOS for remote access..."
          
          # Enable automatic login for current user to avoid login screen
          sudo defaults write /Library/Preferences/com.apple.loginwindow autoLoginUser runner
          
          # Disable screen lock and sleep
          sudo pmset -a displaysleep 0
          sudo pmset -a sleep 0
          sudo pmset -a disksleep 0
          
          # Disable screen saver
          defaults -currentHost write com.apple.screensaver idleTime 0
          
          # Show desktop (in case it's hidden)
          osascript -e 'tell application "System Events" to key code 120' 2>/dev/null || true
          
          echo "macOS configured for remote access"

      - name: Start Tailscale Service and Connect
        env:
          TS_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          echo "Starting Tailscale daemon..."
          # Start daemon with default settings (like the working version)
          sudo tailscaled &
          
          # Wait for daemon to start
          echo "Waiting for Tailscale daemon to start..."
          sleep 5
          
          echo "Connecting to Tailscale network..."
          sudo tailscale up --authkey=$TS_AUTH_KEY --hostname=gh-macos-runner-${{ github.run_id }}
          
          # Wait and get IP
          echo "Waiting for IP assignment..."
          sleep 10
          
          TS_IP=$(tailscale ip -4)
          if [[ -z "$TS_IP" ]]; then
            echo "::error::Failed to get Tailscale IP. Checking status..."
            tailscale status
            exit 1
          fi
          
          echo "Successfully connected to Tailscale"
          echo "Assigned Tailscale IP: $TS_IP"
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Configure VNC Server
        run: |
          echo "Configuring VNC server..."
          
          # Stop ARD if already running
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -deactivate -stop
          
          # Generate VNC password (same as working version)
          VNC_PASSWORD=$(openssl rand -base64 12 | tr -dc 'A-Za-z0-9' | cut -c1-8)
          echo "VNC_PASSWORD=$VNC_PASSWORD" >> $GITHUB_ENV
          
          # Enable ARD with legacy VNC password auth (same as working version)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -access -on -privs -all
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -clientopts -setvnclegacy -vnclegacy yes
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -clientopts -setvncpw -vncpw "$VNC_PASSWORD"
          
          # Restart ARD service
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -activate
          
          echo "VNC server configured successfully"

      - name: Configure macOS UI Access
        run: |
          echo "Configuring UI accessibility..."
          
          # Enable remote management and screen sharing
          sudo systemsetup -setremotelogin on 2>/dev/null || true
          
          # Try to enable Screen Sharing via preferences
          sudo defaults write /var/db/launchd.db/com.apple.launchd/overrides.plist com.apple.screensharing -dict Disabled -bool false 2>/dev/null || true
          
          # Alternative VNC setup if previous methods failed
          if ! lsof -i :5900 >/dev/null 2>&1; then
            echo "Setting up VNC using alternative method..."
            
            # Create VNC configuration
            sudo mkdir -p /Library/Preferences/com.apple.VNCSettings.txt
            echo "$(echo -n "$VNC_PASSWORD" | openssl dgst -md5 -binary | base64)" | sudo tee /var/db/vncserver/vncpasswd >/dev/null 2>&1 || true
            
            # Enable VNC via command line
            sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate off 2>/dev/null || true
            sudo /usr/bin/killall -HUP mDNSResponder 2>/dev/null || true
          fi
          
          echo "UI access configuration completed"

      - name: Display Connection Information
        run: |
          echo "========================================"
          echo "       VNC Access via Tailscale"
          echo "========================================"
          echo "Connect with any VNC client:"
          echo "Address: $TAILSCALE_IP"
          echo "Port: 5900"
          echo "Username: (leave blank)"
          echo "VNC Password: $VNC_PASSWORD"
          echo "========================================"
          echo "Additional connection info:"
          echo "• vnc://$TAILSCALE_IP:5900"
          echo "• $TAILSCALE_IP:0 (display 0)"
          echo ""
          echo "Network Status:"
          tailscale status 2>/dev/null | head -5 || echo "Status check failed"
          echo ""
          echo "The runner will stay active for 6 hours."
          echo "========================================"

      - name: Keep Session Active
        run: |
          echo "Keeping remote access session active..."
          echo "Press Cancel workflow button in GitHub Actions to terminate early"
          
          # Simple keep-alive like the working version
          START_TIME=$(date +%s)
          DURATION=21600  # 6 hours in seconds
          
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            REMAINING=$((DURATION - ELAPSED))
            
            if [ $REMAINING -le 0 ]; then
              echo "Session timeout reached. Terminating..."
              break
            fi
            
            HOURS=$((REMAINING / 3600))
            MINUTES=$(((REMAINING % 3600) / 60))
            
            echo "Session active - Time remaining: ${HOURS}h ${MINUTES}m (IP: $TAILSCALE_IP)"
            
            # Check connections every 15 minutes
            if [ $((ELAPSED % 900)) -eq 0 ]; then
              echo "Status check:"
              if pgrep -x tailscaled >/dev/null; then
                echo "  Tailscale: Running"
              else
                echo "  Tailscale: Not running"
              fi
              
              if lsof -i :5900 >/dev/null 2>&1; then
                echo "  VNC: Running on port 5900"
              else
                echo "  VNC: Port 5900 not active"
              fi
            fi
            
            sleep 60  # Update every minute
          done

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up..."
          sudo tailscale logout 2>/dev/null || true
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -deactivate -stop 2>/dev/null || true
          echo "Cleanup completed"
