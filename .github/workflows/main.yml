name: VNC-macOS

on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Update Homebrew (giới hạn 3 phút)
        timeout-minutes: 3
        run: brew update || echo "brew update failed, continue"

      - name: Cài đặt Tailscale CLI & VNC Viewer
        run: |
          brew install tailscale
          brew install --cask tigervnc-viewer

      - name: Khởi động Tailscale (log chi tiết)
        run: |
          sudo tailscaled & sleep 3
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname="gh-macos-${{ github.run_id }}" --reset || (echo "Tailscale up failed"; exit 1)
          tailscale status
          TS_IP=$(tailscale ip -4 | head -n1)
          echo "TAILSCALE_IP=$TS_IP"
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Cấu hình VNC Server
        run: |
          mkdir -p ~/.vnc
          echo "v137@com" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          cat > ~/.vnc/xstartup <<EOF
          #!/bin/sh
          /usr/bin/open -a Finder
          EOF
          chmod +x ~/.vnc/xstartup
          vncserver :1 -geometry 1280x800 -depth 24

      - name: Thông tin kết nối
        run: |
          echo "=================="
          echo "Connect VNC at $TAILSCALE_IP:5901"
          echo "Password: v137@com"
          echo "=================="

      - name: Giữ phiên
        run: |
          while true; do
            echo "[$(date)] macOS VNC Active"
            sleep 300
          done
