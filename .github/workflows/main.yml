name: Remote Access via Tailscale (VNC) - Final

on:
  workflow_dispatch:

jobs:
  remote_access:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Tailscale
        run: |
          brew install tailscale

      - name: Start Tailscale Service and Connect
        env:
          TS_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          sudo tailscaled &
          sleep 5
          
          sudo tailscale up --authkey=$TS_AUTH_KEY --hostname=gh-macos-runner-${{ github.run_id }}
          
          sleep 10
          
          TS_IP=$(tailscale ip -4)
          
          if [[ -z "$TS_IP" ]]; then
            echo "::error::Failed to get Tailscale IP. Exiting."
            exit 1
          fi
          
          echo "Assigned Tailscale IP: $TS_IP"
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Enable and Secure VNC Server
        run: |
          # Dừng dịch vụ VNC hiện tại
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -deactivate -stop

          # Tạo mật khẩu VNC ngẫu nhiên bằng OpenSSL
          VNC_PASSWORD=$(openssl rand -base64 12 | tr -d '=+/' | cut -c1-12)
          
          # Cấu hình mật khẩu VNC mới
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -access -on -privs -all
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -allowAccessFor -allUsers -privs -all
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -clientopts -setvncpw -vncpw "$VNC_PASSWORD"

          # Lưu mật khẩu VNC vào biến môi trường
          echo "VNC_PASSWORD=$VNC_PASSWORD" >> $GITHUB_ENV

          # Khởi động lại dịch vụ VNC
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -restart

      - name: Display Connection Details
        run: |
          echo "========================================"
          echo "       VNC Access via Tailscale"
          echo "========================================"
          echo "Connect to your runner using a VNC client:"
          echo "Address: $TAILSCALE_IP"
          echo "Port: 5900"
          echo "Username: (Leave this blank)"
          echo "VNC Password: $VNC_PASSWORD"
          echo "========================================"
          echo "The runner will stay active for 6 hours."

      - name: Maintain Connection
        run: |
          echo "Keeping job alive..."
          sleep 21600
