name: VNC-macOS

on:
  push:
    branches:
      - main

jobs:
  macos-vnc:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Update Homebrew
        run: brew update || echo "brew update failed, continue"

      - name: Install TigerVNC (full package, includes vncpasswd)
        run: brew install --cask tigervnc

      - name: Verify vncpasswd installation
        run: which vncpasswd

      - name: Install tailscale
        run: brew install tailscale

      - name: Start tailscaled
        run: sudo tailscaled & sleep 3

      - name: Authenticate tailscale
        run: |
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" --hostname="gh-macos-${{ github.run_id }}" --reset || (echo "Tailscale up failed"; exit 1)
          tailscale status
          TS_IP=$(tailscale ip -4 | head -n1)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Prepare VNC password
        run: |
          mkdir -p ~/.vnc
          echo "yourpassword" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

      - name: Start VNC server
        run: |
          # Khởi động VNC server với độ phân giải và màu sắc mong muốn
          vncserver :1 -geometry 1280x800 -depth 24

      - name: Check VNC server status
        run: vncserver -list

      - name: Show VNC connection info
        run: |
          echo "VNC server started on $(hostname):1"
          echo "Tailscale IP: $TAILSCALE_IP"
          echo "Use your VNC client to connect to $TAILSCALE_IP:5901 with password: yourpassword"

      # Tuỳ chỉnh các bước khác nếu cần thiết
